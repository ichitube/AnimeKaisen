import asyncio
import random
from datetime import datetime

from aiogram import Router, F, Bot
from contextlib import suppress
from aiogram.exceptions import TelegramBadRequest
from aiogram.types import CallbackQuery, Message, InputMediaPhoto, InputMediaAnimation
from aiogram.fsm.context import FSMContext
from aiogram.filters import Command
from data import mongodb, character_photo, card_characters
from filters.chat_type import ChatTypeFilter, CallbackChatTypeFilter
from keyboards.builders import inline_builder, Pagination, pagination_card, reply_builder, menu_button

router = Router()

battle_data = {}

user_data = {}

win_animation = "CgACAgQAAx0CfstymgACDfFmFCIV11emoqYRlGWGZRTtrA46oQACAwMAAtwWDVNLf3iCB-QL9jQE"
lose_animation = "CgACAgQAAx0CfstymgACDfJmEvqMok4D9NPyOY0bevepOE4LpQAC9gIAAu-0jFK0picm9zwgKzQE"
draw_animation = "CgACAgQAAx0CfstymgACDfFmFCIV11emoqYRlGWGZRTtrA46oQACAwMAAtwWDVNLf3iCB-QL9jQE"

win_text = ("ğŸ‘‘ ĞŸĞ¾Ğ±ĞµĞ´Ğ°: ğŸ’€Ğ¡Ğ¾Ğ¿ĞµÑ€Ğ½Ğ¸Ğº Ğ¼ĞµÑ€Ñ‚Ğ²"
            "\n<blockquote expandable>â”€â”€ â€¢âœ§âœ§â€¢ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€"
            "\n  + 100ğŸ€„ï¸ xp, "
            "\n  + 200ğŸ’´ Â¥</blockquote>")
lose_text = ("ğŸ’€ ĞŸĞ¾Ñ€Ğ°Ğ¶ĞµĞ½Ğ¸Ğµ"
             "\n<blockquote expandable>â”€â”€ â€¢âœ§âœ§â€¢ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€"
             "\n  + 55ğŸ€„ï¸ xp, "
             "\n  + 100ğŸ’´ Â¥</blockquote>")
draw_text = ("â˜ ï¸ ĞĞ¸Ñ‡ÑŒÑ"
             "\n<blockquote expandable>â”€â”€ â€¢âœ§âœ§â€¢ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€"
             "\n  + 80ğŸ€„ï¸ xp, "
             "\n  + 150ğŸ’´ Â¥</blockquote>")
surrender_text = "ğŸ´â€â˜ ï¸ ĞŸĞ¾Ñ€Ğ°Ğ¶ĞµĞ½Ğ¸Ğµ"
surrender_r_text = ("ğŸ‘‘ ĞŸĞ¾Ğ±ĞµĞ´Ğ°: ğŸ´â€â˜ ï¸Ğ¡Ğ¾Ğ¿ĞµÑ€Ğ½Ğ¸Ğº ÑĞ´Ğ°Ğ»ÑÑ"
                    "\n<blockquote expandable>â”€â”€ â€¢âœ§âœ§â€¢ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€"
                    "\n  + 100ğŸ€„ï¸ xp, "
                    "\n  + 200ğŸ’´ Â¥</blockquote>")
time_out_text = ("ğŸ‘‘ ĞŸĞ¾Ğ±ĞµĞ´Ğ°: ğŸ•˜Ğ’Ñ€ĞµĞ¼Ñ Ğ²Ñ‹ÑˆĞ»Ğ¾"
                 "\n<blockquote expandable>â”€â”€ â€¢âœ§âœ§â€¢ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€"
                 "\n  + 100ğŸ€„ï¸ xp, "
                 "\n  + 200ğŸ’´ Â¥</blockquote>")


def account_text(ident):
    nested_dict = user_data[ident]  # ĞŸĞ¾Ğ»ÑƒÑ‡Ğ°ĞµĞ¼ Ğ²Ğ»Ğ¾Ğ¶ĞµĞ½Ğ½Ñ‹Ğ¹ ÑĞ»Ğ¾Ğ²Ğ°Ñ€ÑŒ
    key = list(nested_dict.keys())[0]

    d1 = battle_data[ident]["deck"]["d1"]
    d2 = battle_data[ident]["deck"]["d2"]
    d3 = battle_data[ident]["deck"]["d3"]
    d4 = battle_data[ident]["deck"]["d4"]
    d5 = battle_data[ident]["deck"]["d5"]
    d6 = battle_data[ident]["deck"]["d6"]
    text = (f".                    Ë—Ë‹Ë<tg-emoji emoji-id="5215480011322042129">âŒ</tg-emoji> Ğ Ğ°ÑƒĞ½Ğ´ {key}ËËŠË—"
            f"\nâœ§â€¢â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â€¢âœ§"
            f"\nâ–  ğŸƒ<b> Ğ’Ğ°ÑˆĞ° ĞºĞ¾Ğ»Ğ¾Ğ´Ğ°:</b>"
            f"\n<blockquote expandable> â€¢ {d1.status}  {d1.name}"
            f"\n â”—â¤ â”â¤ â€¢ â™¥ï¸{d1.health} â€¢ âš”ï¸{d1.attack} â€¢ ğŸ›¡ï¸{d1.defense}"
            f"\n     â”—â¤ â€¢ âœŠ{d1.strength} â€¢ ğŸ‘£{d1.agility} â€¢ ğŸ§ {d1.intelligence} âœ§ {d1.clas}"
            f"\n\n â€¢ {d2.status}  {d2.name} "
            f"\n â”—â¤ â”â¤ â€¢ â™¥ï¸{d2.health} â€¢ âš”ï¸{d2.attack} â€¢ ğŸ›¡ï¸{d2.defense}"
            f"\n     â”—â¤ â€¢ âœŠ{d2.strength} â€¢ ğŸ‘£{d2.agility} â€¢ ğŸ§ {d2.intelligence} âœ§ {d2.clas}"
            f"\n\n â€¢ {d3.status}  {d3.name}"
            f"\n â”—â¤ â”â¤ â€¢ â™¥ï¸{d3.health} â€¢ âš”ï¸{d3.attack} â€¢ ğŸ›¡ï¸{d3.defense}"
            f"\n     â”—â¤ â€¢ âœŠ{d3.strength} â€¢ ğŸ‘£{d3.agility} â€¢ ğŸ§ {d3.intelligence} âœ§ {d3.clas}"
            f"\n\n â€¢ {d4.status}  {d4.name}"
            f"\n â”—â¤ â”â¤ â€¢ â™¥ï¸{d4.health} â€¢ âš”ï¸{d4.attack} â€¢ ğŸ›¡ï¸{d4.defense}"
            f"\n     â”—â¤ â€¢ âœŠ{d4.strength} â€¢ ğŸ‘£{d4.agility} â€¢ ğŸ§ {d4.intelligence} âœ§ {d4.clas}"
            f"\n\n â€¢ {d5.status}  {d5.name}"
            f"\n â”—â¤ â”â¤ â€¢ â™¥ï¸{d5.health} â€¢ âš”ï¸{d5.attack} â€¢ ğŸ›¡ï¸{d5.defense}"
            f"\n     â”—â¤ â€¢ âœŠ{d5.strength} â€¢ ğŸ‘£{d5.agility} â€¢ ğŸ§ {d5.intelligence} âœ§ {d5.clas}"
            f"\n\n â€¢ {d6.status}  {d6.name}"
            f"\n â”—â¤ â”â¤ â€¢ â™¥ï¸{d6.health} â€¢ âš”ï¸{d6.attack} â€¢ ğŸ›¡ï¸{d6.defense}"
            f"\n     â”—â¤ â€¢ âœŠ{d6.strength} â€¢ ğŸ‘£{d6.agility} â€¢ ğŸ§ {d6.intelligence} âœ§ {d6.clas}</blockquote>"
            f"\nâœ§â€¢â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â€¢âœ§")
    status = [d1.status, d2.status, d3.status, d4.status, d5.status, d6.status]
    user_cb = ["d1", "d2", "d3", "d4", "d5", "d6"]
    return text, status, user_cb, key


def deck_text(character, universe):
    strength = character_photo.get_stats(universe, character, 'arena')['strength']
    agility = character_photo.get_stats(universe, character, 'arena')['agility']
    intelligence = character_photo.get_stats(universe, character, 'arena')['intelligence']
    clas = character_photo.get_stats(universe, character, 'arena')['class']
    hp = strength * 75
    attack = strength * 5 + agility * 5 + intelligence * 5
    defense = (strength + agility + (intelligence // 2)) // 4

    text = (f" â€¢ ğŸ´ {character} "
            f"\n â”—â¤ â€¢ â™¥ï¸{hp} â€¢ âš”ï¸{attack} â€¢ ğŸ›¡ï¸{defense}"
            f"\n     â”—â¤ â€¢ âœŠ{strength} â€¢ ğŸ‘£{agility} â€¢ ğŸ§ {intelligence} âœ§ {clas}")
    return text


@router.callback_query(F.data == "deck")
async def choose_card(callback: CallbackQuery):
    user_id = callback.from_user.id
    account = await mongodb.get_user(user_id)
    universe = account['universe']
    if "deck" not in account:
        await mongodb.update_user(user_id, {"deck": {
            "d1": "empty",
            "d2": "empty",
            "d3": "empty",
            "d4": "empty",
            "d5": "empty",
            "d6": "empty"
        }})
        account = await mongodb.get_user(user_id)

    deck = account.get("deck", {})

    required_fields = {
        "d1": "empty",
        "d2": "empty",
        "d3": "empty",
        "d4": "empty",
        "d5": "empty",
        "d6": "empty"
    }

    for field, value in required_fields.items():
        if field not in deck:
            deck[field] = value

    await mongodb.update_user(user_id, {"deck": deck})
    account = await mongodb.get_user(user_id)

    deck_data = account["deck"]
    first = deck_data["d1"]
    second = deck_data["d2"]
    third = deck_data["d3"]
    fourth = deck_data["d4"]
    fifth = deck_data["d5"]
    sixth = deck_data["d6"]

    if first == "empty":
        f1_msg = f" â€¢ ğŸ´ <i> ĞŸÑƒÑÑ‚Ğ¾Ğ¹ ÑĞ»Ğ¾Ñ‚ </i>"
        f1_icon = "â„¹ï¸"
    else:
        f1_msg = deck_text(first, universe)
        f1_icon = "âœ…"
    if second == "empty":
        f2_msg = f" â€¢ ğŸ´ <i> ĞŸÑƒÑÑ‚Ğ¾Ğ¹ ÑĞ»Ğ¾Ñ‚ </i>"
        f2_icon = "â„¹ï¸"
    else:
        f2_msg = deck_text(second, universe)
        f2_icon = "âœ…"
    if third == "empty":
        f3_msg = f" â€¢ ğŸ´ <i> ĞŸÑƒÑÑ‚Ğ¾Ğ¹ ÑĞ»Ğ¾Ñ‚ </i>"
        f3_icon = "â„¹ï¸"
    else:
        f3_msg = deck_text(third, universe)
        f3_icon = "âœ…"
    if fourth == "empty":
        f4_msg = f" â€¢ ğŸ´ <i> ĞŸÑƒÑÑ‚Ğ¾Ğ¹ ÑĞ»Ğ¾Ñ‚ </i>"
        f4_icon = "â„¹ï¸"
    else:
        f4_msg = deck_text(fourth, universe)
        f4_icon = "âœ…"
    if fifth == "empty":
        f5_msg = f" â€¢ ğŸ´ <i> ĞŸÑƒÑÑ‚Ğ¾Ğ¹ ÑĞ»Ğ¾Ñ‚ </i>"
        f5_icon = "â„¹ï¸"
    else:
        f5_msg = deck_text(fifth, universe)
        f5_icon = "âœ…"
    if sixth == "empty":
        f6_msg = f" â€¢ ğŸ´ <i> ĞŸÑƒÑÑ‚Ğ¾Ğ¹ ÑĞ»Ğ¾Ñ‚ </i>"
        f6_icon = "â„¹ï¸"
    else:
        f6_msg = deck_text(sixth, universe)
        f6_icon = "âœ…"

    if "empty" in deck_data.values():
        msg = "âƒ â„¹ï¸ Ğ•ÑÑ‚ÑŒ Ğ¿ÑƒÑÑ‚Ñ‹Ğµ ÑĞ»Ğ¾Ñ‚Ñ‹ Ğ² ĞºĞ¾Ğ»Ğ¾Ğ´Ğµ"
    else:
        msg = "âƒ âœ… Ğ’Ğ°ÑˆĞ° ĞºĞ¾Ğ»Ğ¾Ğ´Ğ° Ğ³Ğ¾Ñ‚Ğ¾Ğ²Ğ° Ğº Ğ±Ğ¸Ñ‚Ğ²Ğµ"

    pattern = dict(
        caption=f"â–  ğŸƒ<b> Ğ’Ğ°ÑˆĞ° ĞºĞ¾Ğ»Ğ¾Ğ´Ğ°:</b>"
                f"\nâœ§â€¢â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â€¢âœ§"
                f"\n<blockquote expandable>"
                f"{f1_msg}"
                f"\n\n{f2_msg}"
                f"\n\n{f3_msg}"
                f"\n\n{f4_msg}"
                f"\n\n{f5_msg}"
                f"\n\n{f6_msg}"
                f"</blockquote>"
                f"\nâœ§â€¢â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â€¢âœ§"
                f"\n{msg}",
        reply_markup=inline_builder(
            [f"{f1_icon}", f"{f2_icon}", f"{f3_icon}",
             f"{f4_icon}", f"{f5_icon}", f"{f6_icon}",
             "ğŸ”™ ĞĞ°Ğ·Ğ°Ğ´"],
            ["d1", "d2", "d3",
             "d4", "d5", "d6",
             "battle_arena"],
            row_width=[3, 3, 1]
        )
    )

    media_id = InputMediaPhoto(media='AgACAgIAAx0CfstymgACPb1nWiwJUdQC-37DUnytEI6vUZd25wACMvQxG_bt0Epw17D9NcuZQAEAAwIAA3kAAzYE')

    inline_id = callback.inline_message_id
    await callback.message.edit_media(media_id, inline_id)
    await callback.message.edit_caption(inline_id, **pattern)


# @router.callback_query(F.data == "card_opponent")
# async def chose_card(callback: CallbackQuery):
#     if players_data[player_id]["current_card"] is not None:
#         await callback.answer("Ğ’Ñ‹ ÑƒĞ¶Ğµ Ğ²Ñ‹Ğ±Ñ€Ğ°Ğ»Ğ¸ ĞºĞ°Ñ€Ñ‚Ñƒ!", show_alert=True)
#         return
#
#     players_data[player_id]["current_card"] = players_data[player_id]["deck"].pop(card_index)
#
#     if all(p["current_card"] is not None for p in players_data.values()):
#         round_data["waiting_for_choices"] = False
#         await execute_round(callback.message.chat.id)


async def get_inventory(user_id, rarity):
    account = await mongodb.get_user(user_id)
    universe = account['universe']
    invent = account['inventory']['characters'][universe]
    if rarity == "d_divine":
        rarity = "divine"
    elif rarity == "d_mythical":
        rarity = "mythical"
    elif rarity == "d_legendary":
        rarity = "legendary"
    elif rarity == "d_epic":
        rarity = "epic"
    elif rarity == "d_rare":
        rarity = "rare"
    elif rarity == "d_common":
        rarity = "common"
    elif rarity == "d_halloween":
        rarity = "halloween"
    elif rarity == "d_soccer":
        rarity = "soccer"
    return invent[rarity], universe


@router.callback_query(F.data.in_(['d1', 'd2', 'd3', 'd4', 'd5', 'd6']))
async def inventory(callback: CallbackQuery | Message, state: FSMContext):
    await state.update_data(deck=callback.data)
    media_id = "CgACAgIAAxkBAAIVCmXMvbzs7hde-fvY9_4JCwU8W6HpAAKgOwACeyZoSuedvZenkxDNNAQ"
    user_id = callback.from_user.id
    account = await mongodb.get_user(user_id)
    universe = account['universe']
    total_divine = len(account['inventory']['characters'][universe].get('divine', {}))
    total_mythical = len(account['inventory']['characters'][universe].get('mythical', {}))
    total_legendary = len(account['inventory']['characters'][universe].get('legendary', {}))
    total_epic = len(account['inventory']['characters'][universe].get('epic', {}))
    total_rare = len(account['inventory']['characters'][universe].get('rare', {}))
    total_common = len(account['inventory']['characters'][universe].get('common', {}))
    total_elements = 0
    for sublist in account['inventory']['characters'][universe].values():
        for item in sublist:
            if isinstance(item, str):
                total_elements += 1
    msg = (f"\nâ– ğŸƒ ĞšĞ¾Ğ»Ğ¸Ñ‡ĞµÑÑ‚Ğ²Ğ¾ ĞºĞ°Ñ€Ñ‚: {total_elements}"
           f"\n\nâ– ğŸŒ  Ğ‘Ğ¾Ğ¶ĞµÑÑ‚Ğ²ĞµĞ½Ğ½Ñ‹Ğµ ğŸŒŸ {total_divine}"
           f"\nâ– ğŸŒŒ ĞœĞ¸Ñ„Ğ¸Ñ‡ĞµÑĞºĞ¸Ğµ â­ï¸ {total_mythical}"
           f"\nâ– ğŸŒ… Ğ›ĞµĞ³ĞµĞ½Ğ´Ğ°Ñ€Ğ½Ñ‹Ğµ â­ï¸ {total_legendary}"
           f"\nâ– ğŸ† Ğ­Ğ¿Ğ¸Ñ‡ĞµÑĞºĞ¸Ğµ â­ï¸ {total_epic}"
           f"\nâ– ğŸ‡ Ğ ĞµĞ´ĞºĞ¸Ğµ â­ï¸ {total_rare}"
           f"\nâ– ğŸŒ ĞĞ±Ñ‹Ñ‡Ğ½Ñ‹Ğµ â­ï¸ {total_common}")
    buttons = [f"ğŸŒ  Ğ‘Ğ¾Ğ¶ĞµÑÑ‚Ğ²ĞµĞ½Ğ½Ñ‹Ğµ ğŸŒŸ {total_divine}", f"ğŸŒŒ ĞœĞ¸Ñ„Ğ¸Ñ‡ĞµÑĞºĞ¸Ğµ â­ï¸ {total_mythical}", f"ğŸŒ… Ğ›ĞµĞ³ĞµĞ½Ğ´Ğ°Ñ€Ğ½Ñ‹Ğµ â­ï¸ {total_legendary}",
               f"ğŸ† Ğ­Ğ¿Ğ¸Ñ‡ĞµÑĞºĞ¸Ğµ â­ï¸ {total_epic}", f"ğŸ‡ Ğ ĞµĞ´ĞºĞ¸Ğµ â­ï¸ {total_rare}", f"ğŸŒ ĞĞ±Ñ‹Ñ‡Ğ½Ñ‹Ğµ â­ï¸ {total_common}", "ğŸ”™ ĞĞ°Ğ·Ğ°Ğ´"]
    callbacks = ["d_divine", "d_mythical", "d_legendary", "d_epic", "d_rare", "d_common", f"{callback.data}"]

    if universe == "Allstars":
        if "halloween" in account['inventory']['characters']['Allstars']:
            total_halloween = len(account['inventory']['characters']['Allstars'].get('halloween', {}))
            buttons.insert(0, f"ğŸ‘» Halloween ğŸƒ {total_halloween}")
            callbacks.insert(0, "halloween")
        # if "soccer" not in account['inventory']['characters']['Allstars']:
        #     account = await mongodb.get_user(user_id)
        #     await mongodb.update_user(user_id, {"inventory.characters.Allstars.soccer": []})
        #     total_soccer = len(account['inventory']['items'].get('soccer', {}))
        #     buttons.insert(0, f"âš½ï¸ Soccer {total_soccer}")
        #     callbacks.insert(0, "soccer")

    pattern = dict(caption=f"ğŸ¥¡ Ğ˜Ğ½Ğ²ĞµĞ½Ñ‚Ğ°Ñ€ÑŒ"
                           f"\nâ”€â”€ â€¢âœ§âœ§â€¢ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€"
                           f"\nâ– Ğ—Ğ´ĞµÑÑŒ Ğ²Ñ‹ Ğ¼Ğ¾Ğ¶ĞµÑ‚Ğµ ÑƒĞ²Ğ¸Ğ´ĞµÑ‚ÑŒ Ğ²ÑĞµ Ğ²Ğ°ÑˆĞ¸ ğŸƒ ĞºĞ°Ñ€Ñ‚Ñ‹ "
                           f"Ğ¸ Ğ²Ñ‹Ğ±Ñ€Ğ°Ñ‚ÑŒ Ğ¸Ñ… Ğ² ĞºĞ°Ñ‡ĞµÑÑ‚Ğ²Ğµ ğŸ´ Ğ¿ĞµÑ€ÑĞ¾Ğ½Ğ°Ğ¶Ğ° Ğ½Ğ° ÑĞ»Ğ¾Ñ‚ Ğ² ĞºĞ¾Ğ»Ğ¾Ğ´Ğµ"
                           f"\n\nâ– Ğ’Ñ‹Ğ±ĞµÑ€Ğ¸Ñ‚Ğµ âœ¨ Ñ€ĞµĞ´ĞºĞ¾ÑÑ‚ÑŒ ĞºĞ°Ñ€Ñ‚Ñ‹, Ñ‡Ñ‚Ğ¾Ğ±Ñ‹ Ğ¿Ğ¾ÑĞ¼Ğ¾Ñ‚Ñ€ĞµÑ‚ÑŒ"
                           f"\nâ”€â”€ â€¢âœ§âœ§â€¢ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€"
                           f"\nâ– ğŸƒ ĞšĞ¾Ğ»Ğ¸Ñ‡ĞµÑÑ‚Ğ²Ğ¾ ĞºĞ°Ñ€Ñ‚: {total_elements}",
                   reply_markup=inline_builder(
                       buttons,
                       callbacks, row_width=[1]))
    if isinstance(callback, CallbackQuery):
        inline_id = callback.inline_message_id
        media = InputMediaAnimation(media=media_id)
        await callback.message.edit_media(media, inline_id)
        await callback.message.edit_caption(inline_id, **pattern)
    else:
        await callback.answer_animation(animation=media_id, **pattern)


@router.callback_query(F.data.in_(['d_soccer', 'd_halloween', 'd_common', 'd_rare',
                                   'd_epic', 'd_legendary', 'd_mythical', 'd_divine']))
async def inventory(callback: CallbackQuery, state: FSMContext):
    await state.update_data(rarity=callback.data)
    inline_id = callback.inline_message_id
    user_id = callback.from_user.id
    invent, universe = await get_inventory(user_id, callback.data)
    if invent == []:
        await callback.answer("â– âœ–ï¸ Ğ£ Ğ²Ğ°Ñ Ğ½ĞµÑ‚ ĞºĞ°Ñ€Ñ‚ Ğ´Ğ°Ğ½Ğ½Ğ¾Ğ¹ Ñ€ĞµĞ´ĞºĞ¾ÑÑ‚Ğ¸", show_alert=True)
        return
    await state.update_data(character=invent[0])
    await state.update_data(universe=universe)
    avatar = character_photo.get_stats(universe, invent[0], 'avatar')
    avatar_type = character_photo.get_stats(universe, invent[0], 'type')
    if avatar_type == 'photo':
        photo = InputMediaPhoto(media=avatar)
    else:
        photo = InputMediaAnimation(media=avatar)
    rarity = character_photo.get_stats(universe, invent[0], 'rarity')
    msg = f"\nâ– âœ¨ Ğ ĞµĞ´ĞºĞ¾ÑÑ‚ÑŒ: {rarity}"
    if universe not in ['Allstars', 'Allstars(old)']:
        strength = character_photo.get_stats(universe, invent[0], 'arena')['strength']
        agility = character_photo.get_stats(universe, invent[0], 'arena')['agility']
        intelligence = character_photo.get_stats(universe, invent[0], 'arena')['intelligence']
        power = character_photo.get_stats(universe, invent[0], 'arena')['power']
        msg = (f"\nâ– âœ¨ Ğ ĞµĞ´ĞºĞ¾ÑÑ‚ÑŒ: {rarity}"
               f"\nâ– ğŸ—º Ğ’ÑĞµĞ»ĞµĞ½Ğ½Ğ°Ñ: {universe}"
               f"\n\n   âœŠğŸ» Ğ¡Ğ¸Ğ»Ğ°: {strength}"
               f"\n   ğŸ‘£ Ğ›Ğ¾Ğ²ĞºĞ¾ÑÑ‚ÑŒ: {agility}"
               f"\n   ğŸ§  Ğ˜Ğ½Ñ‚ĞµĞ»ĞµĞºÑ‚: {intelligence}"
               f"\n   âšœï¸ ĞœĞ¾Ñ‰ÑŒ: {power}")
    await callback.message.edit_media(photo, inline_id)
    await callback.message.edit_caption(inline_id, caption=f"ğŸ´ {invent[0]}"
                                                           f"\n â”€â”€ â€¢âœ§âœ§â€¢ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€"
                                                           f"{msg}"
                                                           f"\nâ”€â”€â€*Ì¥Ëšâ”€â”€â—Œâ”€â”€â—Œâ”€â”€â€*Ì¥Ëšâ”€â”€â”€â”€"
                                                           f"\nâ– ğŸ”– 1 Ğ¸Ğ· {len(invent)}",
                                        reply_markup=pagination_card())


@router.callback_query(Pagination.filter(F.action.in_(["d_prev", "d_next"])))
async def inventory(callback: CallbackQuery, callback_data: Pagination, state: FSMContext):
    try:
        inline_id = callback.inline_message_id
        page_num = int(callback_data.page)
        user_data = await state.get_data()
        invent, universe = await get_inventory(callback.from_user.id, user_data['rarity'])

        if callback_data.action == "d_next":
            page_num = (page_num + 1) % len(invent)
        elif callback_data.action == "d_prev":
            page_num = (page_num - 1) % len(invent)

        with suppress(TelegramBadRequest):
            await state.update_data(character=invent[page_num])
            avatar = character_photo.get_stats(universe, invent[page_num], 'avatar')
            avatar_type = character_photo.get_stats(universe, invent[page_num], 'type')
            if avatar_type == 'photo':
                photo = InputMediaPhoto(media=avatar)
            else:
                photo = InputMediaAnimation(media=avatar)
            rarity = character_photo.get_stats(universe, invent[page_num], 'rarity')
            msg = f"\nâ– âœ¨ Ğ ĞµĞ´ĞºĞ¾ÑÑ‚ÑŒ: {rarity}"
            if universe not in ['Allstars', 'Allstars(old)']:
                strength = character_photo.get_stats(universe, invent[page_num], 'arena')['strength']
                agility = character_photo.get_stats(universe, invent[page_num], 'arena')['agility']
                intelligence = character_photo.get_stats(universe, invent[page_num], 'arena')['intelligence']
                power = character_photo.get_stats(universe, invent[page_num], 'arena')['power']
                msg = (f"\nâ– âœ¨ Ğ ĞµĞ´ĞºĞ¾ÑÑ‚ÑŒ: {rarity}"
                       f"\nâ– ğŸ—º Ğ’ÑĞµĞ»ĞµĞ½Ğ½Ğ°Ñ: {universe}"
                       f"\n\n   âœŠğŸ» Ğ¡Ğ¸Ğ»Ğ°: {strength}"
                       f"\n   ğŸ‘£ Ğ›Ğ¾Ğ²ĞºĞ¾ÑÑ‚ÑŒ: {agility}"
                       f"\n   ğŸ§  Ğ˜Ğ½Ñ‚ĞµĞ»ĞµĞºÑ‚: {intelligence}"
                       f"\n   âšœï¸ ĞœĞ¾Ñ‰ÑŒ: {power}")

            await callback.message.edit_media(photo, inline_id)
            await callback.message.edit_caption(
                inline_id,
                caption=f"ğŸ´ {invent[page_num]}"
                        f"\n â”€â”€ â€¢âœ§âœ§â€¢ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€"
                        f"{msg}"
                        f"\nâ”€â”€â€*Ì¥Ëšâ”€â”€â—Œâ”€â”€â—Œâ”€â”€â€*Ì¥Ëšâ”€â”€â”€â”€"
                        f"\nâ– ğŸ”– {page_num + 1} Ğ¸Ğ· {len(invent)}",
                reply_markup=pagination_card(page=page_num)
            )
        await callback.answer()
    except KeyError:
        await callback.answer("â– ğŸ”‚ Ğ˜Ğ´Ñ‘Ñ‚ Ñ€Ğ°Ğ·Ñ€Ğ°Ğ±Ğ¾Ñ‚ĞºĞ° Ğ±Ğ¾Ñ‚Ğ° ÑĞ²ÑĞ·Ğ¸ Ñ Ñ‡ĞµĞ¼ ÑĞµÑÑĞ¸Ñ Ğ±Ñ‹Ğ»Ğ° Ğ¾ÑÑ‚Ğ°Ğ½Ğ¾Ğ²Ğ»ĞµĞ½Ğ°, Ğ²Ñ‹Ğ·Ğ¾Ğ²Ğ¸Ñ‚Ğµ "
                              "ğŸ¥¡ Ğ˜Ğ½Ğ²ĞµĞ½Ñ‚Ğ°Ñ€ÑŒ ĞµÑ‰Ğµ Ñ€Ğ°Ğ·", show_alert=True)


@router.callback_query(F.data == "d_choice_card")
async def change_ch(callback: CallbackQuery, state: FSMContext):
    try:
        user_id = callback.from_user.id
        account = await mongodb.get_user(user_id)
        deck = account["deck"]
        data = await state.get_data()
        if data.get('character') in deck.values():
            await callback.answer("â– ğŸ”‚ Ğ­Ñ‚Ğ¾Ñ‚ Ğ¿ĞµÑ€ÑĞ¾Ğ½Ğ°Ğ¶ ÑƒĞ¶Ğµ ĞµÑÑ‚ÑŒ Ğ² ĞºĞ¾Ğ»Ğ¾Ğ´Ğµ", show_alert=True)
            return
        else:
            await mongodb.update_user(user_id, {f"deck.{data.get('deck')}": data.get('character')})
            await callback.answer("ğŸ´ Ğ’Ñ‹ ÑƒÑĞ¿ĞµÑˆĞ½Ğ¾ Ğ²Ñ‹Ğ±Ñ€Ğ°Ğ»Ğ¸ Ğ¿ĞµÑ€ÑĞ¾Ğ½Ğ°Ğ¶Ğ°", show_alert=True)
            await choose_card(callback)
    except KeyError:
        await callback.answer("â– ğŸ”‚ Ğ˜Ğ´Ñ‘Ñ‚ Ñ€Ğ°Ğ·Ñ€Ğ°Ğ±Ğ¾Ñ‚ĞºĞ° Ğ±Ğ¾Ñ‚Ğ° ÑĞ²ÑĞ·Ğ¸ Ñ Ñ‡ĞµĞ¼ ÑĞµÑÑĞ¸Ñ Ğ±Ñ‹Ğ»Ğ° Ğ¾ÑÑ‚Ğ°Ğ½Ğ¾Ğ²Ğ»ĞµĞ½Ğ°, Ğ²Ñ‹Ğ·Ğ¾Ğ²Ğ¸Ñ‚Ğµ "
                              "ğŸ¥¡ Ğ˜Ğ½Ğ²ĞµĞ½Ñ‚Ğ°Ñ€ÑŒ ĞµÑ‰Ğµ Ñ€Ğ°Ğ·", show_alert=True)


async def surrender_f(user_id, r, mes, bot):
    await asyncio.sleep(60)
    if not user_data[user_id][r]:
        user_data[user_id][r] = True  # ĞĞ±Ğ½Ğ¾Ğ²Ğ»ÑĞµĞ¼ ÑĞ¾ÑÑ‚Ğ¾ÑĞ½Ğ¸Ğµ
        account = await mongodb.get_user(user_id)

        if account["battle"]["battle"]["status"] == 4:
            rival = await mongodb.get_user(account["battle"]["battle"]["rid"])
            await bot.send_animation(chat_id=user_id, animation=lose_animation,
                                     caption=surrender_text, reply_markup=menu_button())
            current_date = datetime.today().date()
            current_datetime = datetime.combine(current_date, datetime.time(datetime.now()))
            await mongodb.update_user(account["battle"]["battle"]["rid"], {"tasks.last_arena_fight": current_datetime})
            await mongodb.update_value(account["_id"], {"battle.stats.loses": 1})
            await mongodb.update_value(account["battle"]["battle"]["rid"], {"battle.stats.wins": 1})
            await mongodb.update_value(account["battle"]["battle"]["rid"], {"stats.exp": 100})
            await mongodb.update_value(account["battle"]["battle"]["rid"], {"account.money": 200})
            await mongodb.update_many(
                {"_id": {"$in": [account["_id"]]}},
                {"$set": {"battle.battle.status": 0, "battle.battle.rid": ""}}
            )
            await mongodb.update_many(
                {"_id": {"$in": [rival["_id"]]}},
                {"$set": {"battle.battle.status": 0, "battle.battle.rid": ""}}
            )
            await bot.send_animation(chat_id=rival["_id"], animation=win_animation,
                                     caption=time_out_text, reply_markup=menu_button())
        await bot.edit_message_text(chat_id=user_id, message_id=mes.message_id,
                                    text=f"âœ–ï¸ Ğ’Ñ€ĞµĞ¼Ñ Ğ²Ñ‹ÑˆĞ»Ğ¾ ğŸ•˜", reply_markup=None)


@router.callback_query(F.data == "card_opponent")
async def search_opponent(callback: CallbackQuery | Message, bot: Bot):
    user_id = callback.from_user.id
    account = await mongodb.get_user(user_id)
    universe = account['universe']

    if isinstance(callback, CallbackQuery):
        await callback.message.delete()

    if account["battle"]["battle"]["status"] == 0:
        rival = await mongodb.find_card_opponent()

        await mongodb.update_user(user_id, {"battle.battle.status": 3})

        if rival is None:
            await bot.send_animation(
                chat_id=user_id,
                animation="CgACAgIAAx0CfstymgACBaNly1ESV41gB1s-k4M3VITaGbHvHwACPj8AAlpyWEpUUFtvRlRcpjQE",
                caption=f"\n ğŸ’¡ <blockquote expandable>Ğ’ Ñ€Ğ°Ğ·Ñ€Ğ°Ğ±Ğ¾Ñ‚ĞºĞµ</blockquote>"
                        f"\nâ”€â”€ â€¢âœ§âœ§â€¢ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€"
                        f"\nâ– ğŸ” ĞŸĞ¾Ğ¸ÑĞº ÑĞ¾Ğ¿ĞµÑ€Ğ½Ğ¸ĞºĞ° . . . . .",
                reply_markup=reply_builder("âœ–ï¸ ĞÑ‚Ğ¼ĞµĞ½Ğ°"))
        else:

            ident = account["_id"]
            name = account["name"]
            u_deck = account["deck"]
            character = account['character'][account['universe']]
            avatar = character_photo.get_stats(universe, character, 'avatar')
            avatar_type = character_photo.get_stats(universe, character, 'type')
            slave = None
            if account['inventory']['slaves']:
                slave = account['inventory']['slaves'][0]

            u1_character = card_characters.CardCharacters(ident, name, universe, u_deck["d1"], slave, rival["_id"], "d1")
            u2_character = card_characters.CardCharacters(ident, name, universe, u_deck["d2"], slave, rival["_id"], "d2")
            u3_character = card_characters.CardCharacters(ident, name, universe, u_deck["d3"], slave, rival["_id"], "d3")
            u4_character = card_characters.CardCharacters(ident, name, universe, u_deck["d4"], slave, rival["_id"], "d4")
            u5_character = card_characters.CardCharacters(ident, name, universe, u_deck["d5"], slave, rival["_id"], "d5")
            u6_character = card_characters.CardCharacters(ident, name, universe, u_deck["d6"], slave, rival["_id"], "d6")

            battle_data[ident] = {
                "deck": {"d1": u1_character,
                         "d2": f"â”‹{u2_character}â”‹",
                         "d3": f"â”‹{u3_character}â”‹",
                         "d4": f"â”‹{u4_character}â”‹",
                         "d5": f"â”‹{u5_character}â”‹",
                         "d6": f"â”‹{u6_character}â”‹"},
                "rival": rival["_id"],
                "round": 1,
                "turn": True
            }

            user_data[user_id] = {1: True}

            r_ident = rival["_id"]
            r_universe = rival['universe']
            r_name = rival["name"]
            ru_deck = rival["deck"]
            r_avatar = character_photo.get_stats(r_universe, ru_deck["d1"], 'avatar')
            r_avatar_type = character_photo.get_stats(r_universe, ru_deck["d1"], 'type')
            r_slave = None
            if rival['inventory']['slaves']:
                r_slave = rival['inventory']['slaves'][0]

            r1_character = card_characters.CardCharacters(r_ident, r_name, r_universe, ru_deck["d1"], r_slave, ident, "d1")
            r2_character = card_characters.CardCharacters(r_ident, r_name, r_universe, ru_deck["d2"], r_slave, ident, "d2")
            r3_character = card_characters.CardCharacters(r_ident, r_name, r_universe, ru_deck["d3"], r_slave, ident, "d3")
            r4_character = card_characters.CardCharacters(r_ident, r_name, r_universe, ru_deck["d4"], r_slave, ident, "d4")
            r5_character = card_characters.CardCharacters(r_ident, r_name, r_universe, ru_deck["d5"], r_slave, ident, "d5")
            r6_character = card_characters.CardCharacters(r_ident, r_name, r_universe, ru_deck["d6"], r_slave, ident, "d6")

            battle_data[r_ident] = {
                "deck": {"d1": f"â”‹{r1_character}â”‹",
                         "d2": f"â”‹{r2_character}â”‹",
                         "d3": f"â”‹{r3_character}â”‹",
                         "d4": f"â”‹{r4_character}â”‹",
                         "d5": f"â”‹{r5_character}â”‹",
                         "d6": f"â”‹{r6_character}â”‹"},
                "rival": ident,
                "round": 1,
                "turn": True
            }

            user_data[rival["_id"]] = {1: True}

            user_text = (f" âš”ï¸ CĞ¾Ğ¿ĞµÑ€Ğ½Ğ¸Ğº ĞĞ°Ğ¹Ğ´ĞµĞ½! "
                         f"\nâ”€â”€ â€¢âœ§âœ§â€¢ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€"
                         f"\n ğŸªª  ã€¢ {rival['name']} "
                         f"\nâ”€â”€ â€¢âœ§âœ§â€¢ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€"
                         f"\n<i>ğŸ€„ï¸ ĞĞ¿Ñ‹Ñ‚: {rival['stats']['exp']} XP </i>")

            rival_text = (f"âš”ï¸ CĞ¾Ğ¿ĞµÑ€Ğ½Ğ¸Ğº ĞĞ°Ğ¹Ğ´ĞµĞ½! "
                          f"\nâ”€â”€ â€¢âœ§âœ§â€¢ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€"
                          f"\n ğŸªª  ã€¢ {account['name']} "
                          f"\nâ”€â”€ â€¢âœ§âœ§â€¢ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€"
                          f"\n<i>ğŸ€„ï¸ ĞĞ¿Ñ‹Ñ‚: {account['stats']['exp']} XP </i>")

            await mongodb.update_user(account["_id"], {"battle.battle.status": 4, "battle.battle.rid": rival["_id"]})
            await mongodb.update_user(rival["_id"], {"battle.battle.status": 4, "battle.battle.rid": account["_id"]})

            if r_avatar_type == 'photo':
                await bot.send_photo(chat_id=user_id, caption=user_text, photo=r_avatar,
                                     reply_markup=reply_builder("ğŸ³ï¸ Ğ¡Ğ´Ğ°Ñ‚ÑŒÑÑ"))
            else:
                await bot.send_animation(chat_id=user_id, caption=user_text, animation=r_avatar,
                                         reply_markup=reply_builder("ğŸ³ï¸ Ğ¡Ğ´Ğ°Ñ‚ÑŒÑÑ"))

            if avatar_type == 'photo':
                await bot.send_photo(chat_id=rival["_id"], caption=rival_text, photo=avatar,
                                     reply_markup=reply_builder("ğŸ³ï¸ Ğ¡Ğ´Ğ°Ñ‚ÑŒÑÑ"))
            else:
                await bot.send_animation(chat_id=rival["_id"], caption=rival_text, animation=avatar,
                                         reply_markup=reply_builder("ğŸ³ï¸ Ğ¡Ğ´Ğ°Ñ‚ÑŒÑÑ"))

            user_text, user_status, user_cb, u_round = account_text(ident)
            await bot.send_message(account["_id"], text=f"{user_text}"
                                                        f"\nğŸ”¸ Ğ¡Ğ»ĞµĞ¿Ğ¾Ğ¹ Ñ…Ğ¾Ğ´:",
                                   reply_markup=inline_builder(user_status, user_cb, row_width=[3, 3]),
                                   )

            rival_text, rival_status, rival_cb, r_round = account_text(r_ident)
            mes = await bot.send_message(rival["_id"], text=f"{rival_text}"
                                                            f"\nğŸ”¸ Ğ¡Ğ»ĞµĞ¿Ğ¾Ğ¹ Ñ…Ğ¾Ğ´:",
                                         reply_markup=inline_builder(rival_status, rival_cb, row_width=[3, 3]),
                                         )

            await surrender_f(rival["_id"], r_round, mes, bot)

    elif account["battle"]["battle"]["status"] == 1 or account["battle"]["battle"]["status"] == 3:
        if isinstance(callback, CallbackQuery):
            await callback.answer(
                text="ğŸ’¢ Ğ’Ñ‹ ÑƒĞ¶Ğµ Ğ½Ğ°Ñ…Ğ¾Ğ´Ğ¸Ñ‚ĞµÑÑŒ Ğ² Ğ¿Ğ¾Ğ¸ÑĞºĞµ ÑĞ¾Ğ¿ĞµÑ€Ğ½Ğ¸ĞºĞ°!",
                show_alert=True
            )
        else:
            await callback.answer(text="ğŸ’¢ Ğ’Ñ‹ ÑƒĞ¶Ğµ Ğ½Ğ°Ñ…Ğ¾Ğ´Ğ¸Ñ‚ĞµÑÑŒ Ğ² Ğ¿Ğ¾Ğ¸ÑĞºĞµ ÑĞ¾Ğ¿ĞµÑ€Ğ½Ğ¸ĞºĞ°!")

    elif account["battle"]["battle"]["status"] == 2 or account["battle"]["battle"]["status"] == 4:
        if isinstance(callback, CallbackQuery):
            await callback.answer(
                text="ğŸ’¢ Ğ’Ñ‹ ÑƒĞ¶Ğµ Ğ½Ğ°Ñ…Ğ¾Ğ´Ğ¸Ñ‚ĞµÑÑŒ Ğ² Ğ±Ğ¸Ñ‚Ğ²Ğµ!",
                show_alert=True
            )
        else:
            await callback.answer(text="ğŸ’¢ Ğ’Ñ‹ ÑƒĞ¶Ğµ Ğ½Ğ°Ñ…Ğ¾Ğ´Ğ¸Ñ‚ĞµÑÑŒ Ğ² Ğ±Ğ¸Ñ‚Ğ²Ğµ!")


round_data = {
    "current_round": 1,
    "waiting_for_choices": True,
    "last_winner": None,
}


class Character:
    def __init__(self, name, attack, defense, health, char_class):
        self.name = name
        self.attack = attack
        self.defense = defense
        self.health = health
        self.char_class = char_class  # "Strength", "Agility", "Intelligence"

    def is_alive(self):
        return self.health > 0


class_advantage = {
    ("Strength", "Agility"): 1.5,
    ("Agility", "Intelligence"): 1.5,
    ("Intelligence", "Strength"): 1.5,
}


def calculate_damage(attacker, defender):
    multiplier = class_advantage.get((attacker.char_class, defender.char_class), 1.0)
    damage = (attacker.attack * multiplier) - defender.defense
    return max(damage, 0)


@router.callback_query(CallbackChatTypeFilter(chat_type=["private"]), F.data.startswith("â”‹"))
async def start_battle(callback: CallbackQuery):
    player_id = callback.from_user.id
    opponent_id = await find_opponent(player_id)
    if not opponent_id:
        await callback.message.answer("ĞŸÑ€Ğ¾Ñ‚Ğ¸Ğ²Ğ½Ğ¸Ğº Ğ½Ğµ Ğ½Ğ°Ğ¹Ğ´ĞµĞ½. ĞŸĞ¾Ğ¿Ñ€Ğ¾Ğ±ÑƒĞ¹Ñ‚Ğµ Ğ¿Ğ¾Ğ·Ğ¶Ğµ.")
        return

    players_data[player_id] = {
        "deck": [
            Character("Aizen", 40, 20, 120, "Intelligence"),
            Character("Seishiro", 50, 30, 100, "Agility"),
            Character("Renji", 60, 25, 110, "Strength"),
            Character("Byakuya", 55, 35, 90, "Intelligence"),
            Character("Gin", 50, 20, 100, "Agility"),
        ],
        "current_card": None,
    }

    players_data[opponent_id] = {
        "deck": [
            Character("Kenpachi", 60, 30, 200, "Strength"),
            Character("Ichigo", 55, 25, 120, "Strength"),
            Character("Rukia", 45, 20, 100, "Intelligence"),
            Character("Toshiro", 50, 30, 110, "Agility"),
            Character("Urahara", 50, 25, 120, "Intelligence"),
        ],
        "current_card": None,
    }

    round_data["current_round"] = 1
    round_data["waiting_for_choices"] = True
    round_data["last_winner"] = None

    await callback.message.answer("Ğ‘Ğ¸Ñ‚Ğ²Ğ° Ğ½Ğ°Ñ‡Ğ°Ğ»Ğ°ÑÑŒ! Ğ’Ñ‹Ğ±ĞµÑ€Ğ¸Ñ‚Ğµ Ğ¿ĞµÑ€Ğ²ÑƒÑ ĞºĞ°Ñ€Ñ‚Ñƒ.")
    await send_card_choices(player_id)
    await send_card_choices(opponent_id)


async def send_card_choices(player_id):
    player_data = players_data[player_id]
    buttons = []
    keyboard = types.InlineKeyboardMarkup(row_width=2).add(*buttons)
    await bot.send_message(player_id, "Ğ’Ñ‹Ğ±ĞµÑ€Ğ¸Ñ‚Ğµ ĞºĞ°Ñ€Ñ‚Ñƒ Ğ´Ğ»Ñ Ğ±Ğ¾Ñ:", reply_markup=keyboard)


async def execute_round(chat_id):
    player_ids = list(players_data.keys())
    player1 = players_data[player_ids[0]]
    player2 = players_data[player_ids[1]]
    card1 = player1["current_card"]
    card2 = player2["current_card"]

    result_message = (
        f"Ğ Ğ°ÑƒĞ½Ğ´ {round_data['current_round']}:"
        f"Ğ˜Ğ³Ñ€Ğ¾Ğº 1 Ğ²Ñ‹Ğ±Ñ€Ğ°Ğ» {card1.name} ({card1.char_class}, {card1.health} HP)."
        f"Ğ˜Ğ³Ñ€Ğ¾Ğº 2 Ğ²Ñ‹Ğ±Ñ€Ğ°Ğ» {card2.name} ({card2.char_class}, {card2.health} HP)."
    )

    while card1.is_alive() and card2.is_alive():
        damage_to_card2 = calculate_damage(card1, card2)
        card2.health -= damage_to_card2

        if card2.is_alive():
            damage_to_card1 = calculate_damage(card2, card1)
            card1.health -= damage_to_card1

    if card1.is_alive():
        winner, loser = "Ğ˜Ğ³Ñ€Ğ¾Ğº 1", "Ğ˜Ğ³Ñ€Ğ¾Ğº 2"
        player1["deck"].append(card1)
    else:
        winner, loser = "Ğ˜Ğ³Ñ€Ğ¾Ğº 2", "Ğ˜Ğ³Ñ€Ğ¾Ğº 1"
        player2["deck"].append(card2)

    result_message += f"ĞŸĞ¾Ğ±ĞµĞ´Ğ¸Ñ‚ĞµĞ»ÑŒ Ñ€Ğ°ÑƒĞ½Ğ´Ğ°: {winner}!"
    await bot.send_message(chat_id, result_message)

    # ĞÑ‡Ğ¸ÑÑ‚ĞºĞ° Ñ‚ĞµĞºÑƒÑ‰Ğ¸Ñ… ĞºĞ°Ñ€Ñ‚
    player1["current_card"] = None
    player2["current_card"] = None

    # ĞŸÑ€Ğ¾Ğ²ĞµÑ€ĞºĞ° Ğ½Ğ° Ğ·Ğ°Ğ²ĞµÑ€ÑˆĞµĞ½Ğ¸Ğµ Ğ¸Ğ³Ñ€Ñ‹
    if not player1["deck"]:
        await bot.send_message(chat_id, "Ğ˜Ğ³Ñ€Ğ¾Ğº 2 Ğ¿Ğ¾Ğ±ĞµĞ´Ğ¸Ğ» Ğ² Ğ¸Ğ³Ñ€Ğµ!")
    elif not player2["deck"]:
        await bot.send_message(chat_id, "Ğ˜Ğ³Ñ€Ğ¾Ğº 1 Ğ¿Ğ¾Ğ±ĞµĞ´Ğ¸Ğ» Ğ² Ğ¸Ğ³Ñ€Ğµ!")
    else:
        round_data["current_round"] += 1
        round_data["waiting_for_choices"] = True
        await bot.send_message(chat_id, "Ğ¡Ğ»ĞµĞ´ÑƒÑÑ‰Ğ¸Ğ¹ Ñ€Ğ°ÑƒĞ½Ğ´! Ğ’Ñ‹Ğ±ĞµÑ€Ğ¸Ñ‚Ğµ ĞºĞ°Ñ€Ñ‚Ñ‹.")
        await send_card_choices(player_ids[0])
        await send_card_choices(player_ids[1])


@router.message(ChatTypeFilter(chat_type=["private"]), Command("card_surrender"))
@router.message(F.text == "ğŸ³ï¸ Ğ¡Ğ´Ğ°Ñ‚ÑŒÑÑ")
async def surrender(message: Message, bot: Bot):
    user_id = message.from_user.id
    account = await mongodb.get_user(user_id)

    if account["battle"]["battle"]["status"] == 4:
        if account["battle"]["battle"]["rid"] != user_id * 10:
            rival = await mongodb.get_user(account["battle"]["battle"]["rid"])
        await bot.send_animation(chat_id=user_id, animation=lose_animation,
                                 caption=surrender_text, reply_markup=menu_button())

        await mongodb.update_value(account["_id"], {"battle.stats.loses": 1})
        if account["battle"]["battle"]["rid"] != user_id * 10:
            await mongodb.update_value(account["battle"]["battle"]["rid"], {"battle.stats.wins": 1})
            await mongodb.update_value(account["battle"]["battle"]["rid"], {"stats.exp": 100})
            await mongodb.update_value(account["battle"]["battle"]["rid"], {"account.money": 200})
            current_date = datetime.today().date()
            current_datetime = datetime.combine(current_date, datetime.time(datetime.now()))
            await mongodb.update_user(account["battle"]["battle"]["rid"], {"tasks.last_arena_fight": current_datetime})
        await mongodb.update_many(
            {"_id": {"$in": [account["_id"]]}},
            {"$set": {"battle.battle.status": 0, "battle.battle.rid": ""}}
        )
        if account["battle"]["battle"]["rid"] != user_id * 10:
            await mongodb.update_many(
                {"_id": {"$in": [rival["_id"]]}},
                {"$set": {"battle.battle.status": 0, "battle.battle.rid": ""}}
            )
            await bot.send_animation(chat_id=rival["_id"], animation=win_animation,
                                     caption=surrender_r_text, reply_markup=menu_button())
